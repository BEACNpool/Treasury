<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BEACN · Flags (Catalyst)</title>
  <link rel="stylesheet" href="site.css" />
  <link rel="stylesheet" href="audit-ui.css" />
  <style>
    .wrap{max-width:1200px;margin:0 auto;padding:2rem 1.25rem;}
    .kicker{color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:.85rem;letter-spacing:.08em;text-transform:uppercase;}
    .muted{color:#999;}
    .box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:1.25rem;margin:1rem 0;}
    table{width:100%;border-collapse:collapse;margin-top:.75rem;}
    th,td{border-bottom:1px solid rgba(255,255,255,0.08);padding:.6rem .5rem;text-align:left;vertical-align:top;}
    th{color:#ddd;font-family:'JetBrains Mono',monospace;font-size:.8rem;}
    td{color:#bbb;}
    .num{font-variant-numeric:tabular-nums;white-space:nowrap;}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,0.18);border-radius:999px;padding:.15rem .55rem;font-family:'JetBrains Mono',monospace;font-size:.75rem;color:#ddd;}
    .sev{display:inline-block;border-radius:999px;padding:.15rem .55rem;font-family:'JetBrains Mono',monospace;font-size:.75rem;color:#111;}
    .sev-red{background:#ff5a5a;}
    .sev-orange{background:#ffb15a;}
    .sev-yellow{background:#ffe27a;}
    .sev-green{background:#7dffa1;}
    a{color:var(--gold);}
    code{font-family:'JetBrains Mono',monospace;font-size:.85rem;color:#ddd;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="kicker">BEACN · receipts-first</div>
    <h1 style="margin:.35rem 0 0.75rem 0;">Flags (Catalyst)</h1>

    <div class="audit-pipeline">
      <a class="step" href="catalyst.html">① Receipts</a>
      <span class="arrow">→</span>
      <span class="step active">② Flags</span>
      <span class="arrow">→</span>
      <a class="step" href="ai-audit.html">③ AI Audit</a>
    </div>

    <div class="audit-callout">
      Flags are rule-based triage signals derived from <a href="catalyst.html">Catalyst receipts</a>.
      For deliverable repricing analysis, see <a href="ai-audit.html">AI Audit</a>.
    </div>

    <div class="disclaimer-banner">
      ⚠ Flags are not accusations. Weight is assigned by criteria rubric, not human judgment of guilt.
      Anything implying fraud would require court findings or direct primary receipts.
    </div>
    <p class="muted" style="max-width:980px;">
      Flags are <strong>rule-based triage signals</strong>. They are not accusations.
      This page summarizes signals emitted from the exported Catalyst receipts dataset.
    </p>

    <div class="stat-row">
      <div class="stat-card alert">
        <div class="stat-value" id="flag-count">—</div>
        <div class="stat-label">Total flags emitted</div>
      </div>
      <div class="stat-card alert">
        <div class="stat-value" id="cancelled-paid-count">—</div>
        <div class="stat-label">Cancelled but paid</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-value" id="concentration-count">—</div>
        <div class="stat-label">Concentration flags</div>
      </div>
    </div>

    <div class="box">
      <h2 style="margin:0 0 .5rem 0;">Weighting (AI-driven, criteria-based)</h2>
      <p class="muted" style="margin:.25rem 0 0 0;max-width:980px;">
        Each flag type has a <strong>weight (1–10)</strong> used for visual prioritization.
        Weight is assigned by a simple criteria rubric (not human judgment of guilt):
        <br><br>
        <strong>+3</strong> if it’s a direct receipts field (offchain) rather than a heuristic guess<br>
        <strong>+3</strong> if it indicates funds moved (distributedToDate &gt; 0) rather than just votes/intent<br>
        <strong>+2</strong> if it implies a missing/unclear delivery record (needs follow-up receipts)<br>
        <strong>+2</strong> if the signal is hard to explain benignly at scale<br>
        <br><br>
        Heuristic-only flags are intentionally lower weight.
        Anything implying fraud would require court findings or direct primary receipts; we do not emit “fraud” flags from heuristics.
      </p>
    </div>

    <div class="audit-hero">
      <h2>Download the flagged-proposals dataset</h2>
      <p>
        These CSVs list each proposal (deduped) and the flags it received (count + weight + flag IDs).
        Sort in Excel/Sheets by <strong>flag_weight_total</strong> to prioritize review.
      </p>
      <div class="cta-links">
        <a href="outputs/offchain/flags/approved_projects_with_flags.csv" target="_blank">⬇ approved_projects_with_flags.csv</a>
        <a href="outputs/offchain/flags/proposers_with_flags.csv" target="_blank">⬇ proposers_with_flags.csv</a>
        <a href="outputs/offchain/flags/catalyst_flags_v2.json" target="_blank">Raw flags (JSON)</a>
      </div>
      <div class="muted" style="margin-top:0.75rem; font-family:var(--mono); font-size:0.8rem;">
        Receipts: <a href="catalyst.html" target="_blank">Catalyst receipts</a>
      </div>
    </div>

    <div class="box">
      <h2 style="margin:0 0 .5rem 0;">Heuristic flags (visual-only) — what they mean</h2>
      <p class="muted" style="margin:.25rem 0 0 0;max-width:980px;">
        Two of the flags in this dataset are intentionally low weight and green because they are <strong>heuristics</strong> —
        they exist to help reviewers <em>filter</em> and <em>prioritize</em>, not to assert anything about intent or delivery.
      </p>

      <div style="margin-top:0.75rem;" class="muted">
        <div style="margin-bottom:0.75rem;">
          <span class="pill">F-AI-001</span>
          <strong>AI-compressible deliverable category</strong> (heuristic)
          <div style="margin-top:0.35rem;">
            <strong>What triggers it:</strong> the proposal title matches a v0 keyword classifier for categories where,
            in 2026, the marginal cost of producing the deliverable is often dramatically lower due to AI-assisted tooling.
          </div>
          <div style="margin-top:0.35rem;">
            <strong>Examples of categories:</strong> translations, short-form content, social media packs, basic dashboards,
            simple scrapers/bots, templated websites, documentation/handbooks.
          </div>
          <div style="margin-top:0.35rem;">
            <strong>Why it’s a flag:</strong> not “bad,” just “reprice this.” It’s a budgeting lens:
            if something is cheap to reproduce today, we should demand tighter scopes, clearer milestones,
            and receipts showing real impact.
          </div>
          <div style="margin-top:0.35rem;">
            <strong>Common false positives:</strong> titles that sound like content/software but actually include deeper work
            (research, legal work, complex infrastructure, ongoing ops).
          </div>
          <div style="margin-top:0.35rem;">
            <strong>Clears-if (bring receipts):</strong> deliverables are substantial/technical, or cost breakdown + receipts
            show the work was not “AI-cheap” in practice.
          </div>

          <div style="margin-top:0.75rem;">
            <span class="pill">Examples (from CSV)</span>
            <div class="muted" style="margin-top:0.35rem;">A few random rows that trigger this heuristic (for illustration only):</div>
            <div class="tableWrap" style="margin-top:0.5rem; max-height:220px;">
              <table>
                <thead><tr><th>Project</th><th>Fund</th><th>Paid</th><th>Link</th></tr></thead>
                <tbody id="ex_fai001"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div>
          <span class="pill">F-CAT-002</span>
          <strong>Keyword-based “content-like” pattern</strong> (heuristic)
          <div style="margin-top:0.35rem;">
            <strong>What triggers it:</strong> the title contains content-adjacent terms (example patterns: “podcast”, “video”,
            “marketing”, “social”, “community”, “newsletter”, “blog”, “media”, “ambassador”, “education”).
          </div>
          <div style="margin-top:0.35rem;">
            <strong>Why it’s a flag:</strong> content work can be valuable, but it’s also where receipts and ROI tend to be
            the least concrete. This flag pushes reviewers to ask: <em>what exactly was delivered</em>, and <em>what measurable outcome</em>
            was achieved?
          </div>
          <div style="margin-top:0.35rem;">
            <strong>Clears-if (bring receipts):</strong> public outputs + dates + links + metrics (views, signups, users onboarded,
            tx volume impact) OR a detailed deliverables list tied to milestones.
          </div>
        </div>

        <div style="margin-top:1rem;">
          <span class="pill">Examples (from CSV)</span>
          <div class="muted" style="margin-top:0.35rem;">A few random rows that trigger this heuristic (for illustration only):</div>
          <div class="tableWrap" style="margin-top:0.5rem; max-height:220px;">
            <table>
              <thead><tr><th>Project</th><th>Fund</th><th>Paid</th><th>Link</th></tr></thead>
              <tbody id="ex_fcat002"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="box">
      <h2 style="margin:0 0 .5rem 0;">Counts by flag type</h2>
      <table>
        <thead>
          <tr><th>Flag</th><th>Weight</th><th>Severity</th><th>Count</th><th>Notes</th></tr>
        </thead>
        <tbody id="flagCounts"></tbody>
      </table>
    </div>

    <div class="box">
      <h2 style="margin:0 0 .5rem 0;">Top concentration (F-CAT-001)</h2>
      <div class="muted">Largest proposer totals by ADA-coded <code>distributedToDate</code> (export).</div>
      <table>
        <thead><tr><th>Proposer</th><th>Paid proposals</th><th>Total (₳)</th><th>Receipt</th></tr></thead>
        <tbody id="topConcentration"></tbody>
      </table>
    </div>

    <div class="box">
      <h2 style="margin:0 0 .5rem 0;">Largest “cancelled but paid” (F-CAT-003)</h2>
      <div class="muted">These require follow-up receipts for what was delivered for the paid amount.</div>
      <table>
        <thead><tr><th>Project</th><th>Fund</th><th>Proposer</th><th>Paid (₳)</th><th>Receipt</th></tr></thead>
        <tbody id="cancelledPaid"></tbody>
      </table>
    </div>

    <div class="box">
      <h2 style="margin:0 0 .5rem 0;">Flag score (visual priority)</h2>
      <div class="muted">Computed as <code>sum(weights)</code> per entity_id. This is not a guilt score; it’s a triage ordering.</div>
      <table>
        <thead><tr><th>Entity</th><th>Score</th><th>Top contributing flags</th></tr></thead>
        <tbody id="scoreboard"></tbody>
      </table>
    </div>

  </div>

<script>
const FLAG_WEIGHTS = {
  // weights 1–10 (visual priority only)
  'F-CAT-001': { weight: 6, severity: 'yellow', note: 'High proposer concentration (needs review; can be benign for vendors)' },
  'F-CAT-002': { weight: 2, severity: 'green',  note: 'Keyword-based “content-like” title pattern (heuristic; prompts reviewers to demand concrete deliverables + ROI receipts)' },
  'F-CAT-003': { weight: 7, severity: 'orange', note: 'Cancelled but paid (requires receipts for delivered work)' },
  'F-CAT-004': { weight: 1, severity: 'green',  note: 'Shared non-default avatar (heuristic; low signal)' },
  'F-CAT-005': { weight: 3, severity: 'yellow', note: 'Duplicate/near-duplicate paid names across proposers (heuristic)' },
  'F-AI-001':  { weight: 1, severity: 'green',  note: 'AI-compressible deliverable category (heuristic; budgeting lens to “reprice this”, not a wrongdoing claim)' },
};

function sevBadge(sev){
  const cls = sev==='red'?'sev-red': sev==='orange'?'sev-orange': sev==='yellow'?'sev-yellow':'sev-green';
  return `<span class="sev ${cls}">${sev}</span>`;
}

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',');
  const rows = [];
  for (const line of lines.slice(1)){
    const cols = [];
    let cur='', inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch==='"'){ inQ=!inQ; continue; }
      if (ch===',' && !inQ){ cols.push(cur); cur=''; }
      else cur+=ch;
    }
    cols.push(cur);
    const obj={};
    headers.forEach((h,i)=>obj[h]=cols[i]);
    rows.push(obj);
  }
  return rows;
}

function fillExampleTable(tbodyId, rows){
  const tb = document.getElementById(tbodyId);
  if (!tb) return;
  tb.innerHTML = '';
  for (const r of rows){
    const code = r.distributedToDate_code || '';
    const amt = Number(r.distributedToDate_amount || 0);
    const paid = `${code} ${amt.toLocaleString(undefined,{maximumFractionDigits:2})}`.trim();
    const fund = r.fundId || '';
    const name = r.projectName || '';
    const url = r.ideascaleUrl || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td title="${name}">${name}</td>
      <td class="num">${fund}</td>
      <td class="num">${paid}</td>
      <td>${url ? `<a href="${url}" target="_blank" rel="noreferrer">receipt</a>` : ''}</td>
    `;
    tb.appendChild(tr);
  }
  if (!rows.length){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td colspan="4" class="muted">(no examples found)</td>`;
    tb.appendChild(tr);
  }
}

async function main(){
  const flagsPath = 'outputs/offchain/flags/catalyst_flags_v2.json';
  const data = await (await fetch(flagsPath)).json();
  const flags = data.flags || [];

  // Top stat cards
  const elFlagCount = document.getElementById('flag-count');
  const elCancelledPaid = document.getElementById('cancelled-paid-count');
  const elConc = document.getElementById('concentration-count');
  if (elFlagCount) elFlagCount.textContent = flags.length.toLocaleString();
  if (elCancelledPaid) elCancelledPaid.textContent = flags.filter(f=>f.flag_id==='F-CAT-003').length.toLocaleString();
  if (elConc) elConc.textContent = flags.filter(f=>f.flag_id==='F-CAT-001').length.toLocaleString();

  // Heuristic examples (pull a few from the per-project CSV)
  try{
    const csvText = await (await fetch('outputs/offchain/flags/approved_projects_with_flags.csv')).text();
    const rows = parseCSV(csvText);
    const pick = (flagId) => rows
      .filter(r => (r.flag_ids||'').includes(flagId))
      .sort((a,b)=> Number(b.distributedToDate_amount||0) - Number(a.distributedToDate_amount||0))
      .slice(0, 5);
    fillExampleTable('ex_fai001', pick('F-AI-001'));
    fillExampleTable('ex_fcat002', pick('F-CAT-002'));
  } catch(e){
    // ignore (examples are optional)
  }

  // counts by type
  const counts = {};
  for (const f of flags){ counts[f.flag_id] = (counts[f.flag_id]||0)+1; }

  const tbody = document.getElementById('flagCounts');
  const ids = Object.keys(counts).sort();
  for (const id of ids){
    const meta = FLAG_WEIGHTS[id] || {weight:1,severity:'green',note:'(unweighted)'};
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><code>${id}</code></td><td class="num">${meta.weight}</td><td>${sevBadge(meta.severity)}</td><td class="num">${counts[id]}</td><td class="muted">${meta.note}</td>`;
    tbody.appendChild(tr);
  }

  // top concentration
  const f1 = flags.filter(f=>f.flag_id==='F-CAT-001');
  f1.sort((a,b)=> (b.evidence?.total_distributedToDate_ada||0) - (a.evidence?.total_distributedToDate_ada||0));
  const topBody = document.getElementById('topConcentration');
  for (const f of f1.slice(0,20)){
    const pr = f.evidence?.proposer || {};
    const total = f.evidence?.total_distributedToDate_ada || 0;
    const paidCt = f.evidence?.paid_projects_count || 0;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${pr.username || '(unknown)'}<div class="muted">${pr.name || ''}</div></td><td class="num">${paidCt}</td><td class="num">₳${Number(total).toLocaleString(undefined,{maximumFractionDigits:2})}</td><td><a href="catalyst.html" target="_blank">receipts</a></td>`;
    topBody.appendChild(tr);
  }

  // cancelled but paid largest
  const f3 = flags.filter(f=>f.flag_id==='F-CAT-003');
  const f3Ada = [];
  for (const f of f3){
    const dist = f.evidence?.project?.distributedToDate;
    if (dist?.code !== '$ADA') continue;
    const amt = Number(dist.amount) / Math.pow(10, Number(dist.exp));
    f3Ada.push({amt, f});
  }
  f3Ada.sort((a,b)=>b.amt-a.amt);
  const canBody = document.getElementById('cancelledPaid');
  for (const row of f3Ada.slice(0,30)){
    const f=row.f;
    const pr=f.evidence?.proposer||{};
    const p=f.evidence?.project||{};
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${p.projectName||''}</td><td class="num">${p.fundId||''}</td><td>${pr.username||''}</td><td class="num">₳${row.amt.toLocaleString(undefined,{maximumFractionDigits:2})}</td><td><a href="catalyst.html" target="_blank">receipts</a></td>`;
    canBody.appendChild(tr);
  }

  // flag score leaderboard (entity_id)
  const score = {};
  const contrib = {};
  for (const f of flags){
    const meta = FLAG_WEIGHTS[f.flag_id] || {weight:1};
    const w = meta.weight || 1;
    score[f.entity_id] = (score[f.entity_id]||0) + w;
    contrib[f.entity_id] = contrib[f.entity_id] || {};
    contrib[f.entity_id][f.flag_id] = (contrib[f.entity_id][f.flag_id]||0) + w;
  }
  const scored = Object.entries(score).map(([entity, sc])=>({entity, sc}));
  scored.sort((a,b)=>b.sc-a.sc);
  const sb = document.getElementById('scoreboard');
  for (const row of scored.slice(0,30)){
    const c = contrib[row.entity] || {};
    const top = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k}(${v})`).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><code>${row.entity}</code></td><td class="num">${row.sc}</td><td class="muted">${top}</td>`;
    sb.appendChild(tr);
  }
}

main().catch(err=>{
  console.error(err);
  document.body.innerHTML = '<div style="color:#fff;padding:2rem;font-family:monospace;">Failed to load flags dataset.</div>';
});
</script>
</body>
</html>
