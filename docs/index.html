<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BEACN — Cardano Treasury & Reserves</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:          #06090f;
  --bg-raised:   #0c1119;
  --bg-card:     #111824;
  --bg-inset:    #080c14;
  --border:      #1a2332;
  --border-dim:  #131c28;
  --border-lit:  #253347;
  --text:        #e2e8f0;
  --text-2:      #94a3b8;
  --text-3:      #4f6479;
  --trs:         #22d3ee;
  --trs-dim:     rgba(34,211,238,.12);
  --res:         #a78bfa;
  --res-dim:     rgba(167,139,250,.12);
  --fees:        #34d399;
  --expansion:   #fb923c;
  --withdraw:    #f87171;
  --ncl:         #facc15;
  --catalyst:    #818cf8;
  --supply:      #f472b6;
  --combined:    #38bdf8;
  --mono: 'DM Mono', monospace;
  --sans: 'Instrument Sans', system-ui, sans-serif;
  --radius: 10px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:var(--sans);background:var(--bg);color:var(--text);line-height:1.55;-webkit-font-smoothing:antialiased;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(6,9,15,.35) 2px,rgba(6,9,15,.35) 4px);pointer-events:none;z-index:9999;opacity:.18;}
.wrap{max-width:1320px;margin:0 auto;padding:0 28px;position:relative;z-index:1;}

/* ── Nav ── */
nav{position:sticky;top:0;z-index:100;background:rgba(6,9,15,.88);backdrop-filter:blur(14px);border-bottom:1px solid var(--border-dim);padding:0 28px;}
nav .inner{max-width:1320px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:52px;}
nav .brand{font-family:var(--mono);font-size:13px;font-weight:500;color:var(--trs);letter-spacing:.5px;}
nav .brand span{color:var(--text-3);font-weight:300;}
.ext-links{display:flex;gap:8px;}
.ext-links a{font-family:var(--mono);font-size:10px;color:var(--text-3);text-decoration:none;padding:4px 10px;border:1px solid var(--border);border-radius:5px;transition:all .15s;}
.ext-links a:hover{color:var(--trs);border-color:var(--trs);}

/* ── Hero ── */
.hero{padding:56px 0 40px;border-bottom:1px solid var(--border-dim);}
.hero h1{font-size:34px;font-weight:700;letter-spacing:-.8px;line-height:1.15;}
.hero h1 .trs{color:var(--trs);}
.hero h1 .res{color:var(--res);}
.hero .sub{margin-top:12px;font-size:14.5px;color:var(--text-2);max-width:600px;line-height:1.6;}
.hero .sub strong{color:var(--text);font-weight:600;}

/* ── 3-Box Stats ── */
.top-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:36px 0 32px;}
.ts{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:22px 24px;position:relative;overflow:hidden;}
.ts::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.ts.t::after{background:var(--trs);}
.ts.r::after{background:var(--res);}
.ts.f::after{background:var(--fees);}
.ts-lbl{font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:1.4px;color:var(--text-3);margin-bottom:8px;}
.ts-val{font-size:28px;font-weight:700;letter-spacing:-.5px;}
.ts-note{font-family:var(--mono);font-size:11px;color:var(--text-3);margin-top:5px;}

/* ── Cards & Charts ── */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;position:relative;margin-bottom:24px;}
.card-title{font-size:15px;font-weight:600;margin-bottom:14px;}
.chart-note{font-size:12px;color:var(--text-3);margin-top:12px;font-style:italic;line-height:1.5;}
.source-tag{display:inline-block;font-family:var(--mono);font-size:10px;color:var(--text-3);background:var(--bg-card);border:1px solid var(--border);border-radius:4px;padding:3px 9px;margin-top:8px;}

/* ── Section System ── */
.section{padding:48px 0 0;}
.section+.section{border-top:1px solid var(--border-dim);}
.s-label{font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-3);margin-bottom:6px;}
.s-title{font-size:22px;font-weight:700;letter-spacing:-.3px;display:flex;align-items:center;gap:10px;}
.s-title .pip{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
.s-desc{font-size:13.5px;color:var(--text-2);margin-top:6px;max-width:640px;}
.s-head{margin-bottom:28px;}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--border-lit),transparent);margin:48px 0 0;}

/* ── Grids ── */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:768px){.g2{grid-template-columns:1fr;}.top-stats{grid-template-columns:1fr;}}

/* ── Stats (inner sections) ── */
.stats{display:grid;gap:14px;margin-bottom:24px;}
.stats.c4{grid-template-columns:repeat(4,1fr);}
.stats.c3{grid-template-columns:repeat(3,1fr);}
@media(max-width:900px){.stats.c4{grid-template-columns:repeat(2,1fr);}}
@media(max-width:480px){.stats.c4,.stats.c3{grid-template-columns:1fr;}}
.stat{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;position:relative;overflow:hidden;}
.stat::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat.t::after{background:var(--trs);}.stat.r::after{background:var(--res);}
.stat.w::after{background:var(--withdraw);}.stat.n::after{background:var(--ncl);}
.stat.f::after{background:var(--fees);}
.stat-lbl{font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-3);margin-bottom:5px;}
.stat-val{font-size:22px;font-weight:700;letter-spacing:-.4px;}
.stat-note{font-family:var(--mono);font-size:11px;color:var(--text-3);margin-top:3px;}

/* ── Progress Bar ── */
.pbar-shell{height:32px;background:var(--bg);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.pbar-fill{height:100%;border-radius:6px 0 0 6px;position:relative;}
.pbar-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:2px;background:#fff;box-shadow:0 0 8px rgba(255,255,255,.4);}
.pbar-labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;color:var(--text-3);margin-top:6px;}

/* ── Budget List ── */
.bud-list{list-style:none;}
.bud-item{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border-dim);font-size:13px;transition:background .1s;}
.bud-item:last-child{border-bottom:none;}
.bud-item:hover{background:rgba(255,255,255,.015);}
.bud-name{display:flex;align-items:center;gap:10px;color:var(--text-2);}
.bud-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
.bud-val{font-family:var(--mono);font-weight:500;color:var(--text);}

/* ── Tables ── */
.tbl-wrap{border-radius:var(--radius);border:1px solid var(--border);overflow-x:auto;background:var(--bg-card);}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead{background:var(--bg);}
th{padding:10px 16px;font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-3);text-align:left;font-weight:500;border-bottom:1px solid var(--border);}
td{padding:10px 16px;border-bottom:1px solid var(--border-dim);color:var(--text-2);}
tr:hover td{background:rgba(255,255,255,.015);}
td.num{font-family:var(--mono);font-weight:500;}
.badge{font-family:var(--mono);font-size:9px;padding:3px 7px;border-radius:4px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;}
.badge-ok{background:rgba(52,211,153,.1);color:var(--fees);border:1px solid rgba(52,211,153,.2);}
.badge-pen{background:rgba(250,204,21,.08);color:var(--ncl);border:1px solid rgba(250,204,21,.15);}

/* ── Downloads ── */
.dl-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}
.dl-row a{font-family:var(--mono);font-size:11px;color:var(--catalyst);text-decoration:none;padding:5px 12px;border:1px solid rgba(129,140,248,.25);border-radius:5px;transition:all .15s;}
.dl-row a:hover{background:rgba(129,140,248,.06);border-color:var(--catalyst);}

/* ── Scenario Buttons ── */
.scn-btns{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;}
.scn-btn{font-family:var(--mono);font-size:11px;padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-3);cursor:pointer;transition:all .15s;}
.scn-btn.on,.scn-btn:hover{border-color:var(--combined);color:var(--combined);background:rgba(56,189,248,.05);} 

/* ── Inline leaderboard viewer ── */
.btn{font-family:var(--mono);font-size:10px;color:var(--text-3);text-decoration:none;padding:4px 10px;border:1px solid var(--border);border-radius:5px;transition:all .15s;background:transparent;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
.btn:hover{color:var(--trs);border-color:var(--trs);}
.btn-mini{padding:3px 8px;font-size:10px;border-radius:5px;}
.viewer{margin-top:14px;border:1px solid var(--border);border-radius:10px;padding:12px 14px;background:rgba(255,255,255,0.02)}
.viewer summary{cursor:pointer;color:var(--text-2);font-size:13px}
.viewer[open] summary{color:var(--text)}
#viewer-table th, #viewer-table td{font-size:11px}


/* ── SQL ── */
.sql-section{padding-top:48px;border-top:1px solid var(--border-dim);margin-top:48px;}
.sql-block{margin-bottom:28px;}
.sql-block h3{font-size:14px;font-weight:600;color:var(--trs);display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.sql-block .qn{font-family:var(--mono);font-size:10px;background:var(--trs-dim);border:1px solid rgba(34,211,238,.2);padding:2px 8px;border-radius:4px;color:var(--trs);}
.sql-block .sd{font-size:12px;color:var(--text-3);margin-bottom:8px;}
pre{background:#050810;border:1px solid var(--border);border-radius:8px;padding:18px;overflow-x:auto;font-family:var(--mono);font-size:12px;line-height:1.75;color:#c9d1d9;}
pre .k{color:#ff7b72;}pre .f{color:#d2a8ff;}pre .s{color:#a5d6ff;}pre .c{color:#484f58;font-style:italic;}pre .n{color:#79c0ff;}pre .v{color:#7ee787;}

/* ── Footer ── */
footer{border-top:1px solid var(--border-dim);padding:36px 0;margin-top:60px;text-align:center;}
footer .f1{font-family:var(--mono);font-size:12px;color:var(--text-3);}
footer .f2{font-size:13px;color:var(--text-2);font-style:italic;margin-top:6px;}
</style>
</head>
<body>

<!-- ═══════════ NAV ═══════════ -->
<nav>
  <div class="inner">
    <div class="brand">BEACN <span>treasury</span></div>
    <div class="ext-links">
      <a href="https://github.com/BEACNpool/Treasury">GitHub</a>
      <a href="https://github.com/BEACNpool/Treasury/blob/main/docs/methodology.md">Methodology</a>
    </div>
  </div>
</nav>

<div class="wrap">

<!-- ═══════════ HERO ═══════════ -->
<div class="hero">
  <h1>The life of Cardano's<br><span class="trs">Treasury</span> & <span class="res">Reserves</span></h1>
  <p class="sub">
    <strong>Money in. Money out.</strong> An open-source view of Cardano's total unallocated wealth —
    where it comes from, where it goes, and how long it lasts. Every number traceable to db-sync.
  </p>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     TOP: 3 BOXES — Treasury / Reserves / Lifetime Fee Income
     Money in vs money out at a glance.
     ═══════════════════════════════════════════════════════════════════════════ -->
<div class="top-stats">
  <div class="ts t">
    <div class="ts-lbl">Treasury Balance</div>
    <div class="ts-val" style="color:var(--trs)">₳1.59B</div>
    <div class="ts-note">spending account · epoch ~530</div>
  </div>
  <div class="ts r">
    <div class="ts-lbl">Reserves Balance</div>
    <div class="ts-val" style="color:var(--res)">₳8.97B</div>
    <div class="ts-note">feeds treasury + stakers · depleting</div>
  </div>
  <div class="ts f">
    <div class="ts-lbl">Lifetime TX Fee Income</div>
    <div class="ts-val" style="color:var(--fees)">₳148M</div>
    <div class="ts-note">total fees collected across all epochs</div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     CHART 1: Cumulative TX Fee Income (revenue)
     ═══════════════════════════════════════════════════════════════════════════ -->
<div class="card">
  <div class="card-title">Cumulative TX Fee Income — Life of Chain</div>
  <canvas id="feeIncomeChart" height="150"></canvas>
  <p class="chart-note">This is the cleanest, ledger-native revenue signal: total transaction fees collected over time. It only goes up. As reserves deplete, fees become the long-run source of treasury replenishment.</p>
  <span class="source-tag">ada_pots.fees (cumulative)</span>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     CHART 2: Treasury + Reserves (spending pools)
     ═══════════════════════════════════════════════════════════════════════════ -->
<div class="card">
  <div class="card-title">Treasury & Reserves — Life of Chain</div>
  <canvas id="treasuryReservesChart" height="150"></canvas>
  <p class="chart-note">Treasury (teal) is the spending pool; reserves (violet) are the emission source and trend down structurally. This chart focuses only on the two pots (no fee line) so the outflow picture is clear.</p>
  <span class="source-tag">ada_pots (balances)</span>
</div>

<div class="divider"></div>

<!-- Budget/Withdrawals sections removed: not yet wired to published on-chain outputs. -->

<!-- Treasury withdrawals section removed: not yet wired to published on-chain outputs. -->

<div class="divider"></div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     CATALYST (OFF-CHAIN)
     ═══════════════════════════════════════════════════════════════════════════ -->
<div class="section">
  <div class="s-head">
    <div class="s-label">Off-Chain Context</div>
    <div class="s-title"><span class="pip" style="background:var(--catalyst)"></span> Catalyst Fund Distributions</div>
    <p class="s-desc">Scraped from projectcatalyst.io (verbatim). Used for analysis context — not ledger-truth. Shows historical fund-level distributions.</p>
  </div>

  <div class="card">
    <canvas id="catalystBarChart" height="100"></canvas>

    <div class="dl-row">
      <a href="outputs/offchain/catalyst/catalyst_proposers_full.json.gz">Full json.gz</a>
      <a href="outputs/offchain/catalyst/manifest.sha256">sha256</a>
      <a href="outputs/offchain/catalyst/top_recipients.csv">Top recipients CSV</a>
      <a href="outputs/offchain/catalyst/analytics/meta.json">AI-curated analytics meta</a>
      <a href="outputs/offchain/catalyst/analytics/proposer_signals.csv">Signals CSV</a>
    </div>

    <div class="stats c3" style="margin-top:14px;margin-bottom:0;">
      <div class="stat" style="text-align:center;">
        <div class="stat-lbl">Concentration (Top 10)</div>
        <div class="stat-val" id="catalyst-conc-top10" style="font-size:18px;">—</div>
      </div>
      <div class="stat" style="text-align:center;">
        <div class="stat-lbl">Concentration (Top 50)</div>
        <div class="stat-val" id="catalyst-conc-top50" style="font-size:18px;">—</div>
      </div>
      <div class="stat" style="text-align:center;">
        <div class="stat-lbl">Signals rows</div>
        <div class="stat-val" id="catalyst-signals-count" style="font-size:18px;">—</div>
      </div>
    </div>

    <div class="tbl-wrap" style="margin-top:14px;">
      <table>
        <thead><tr><th>Leaderboard</th><th>View</th><th>Download</th></tr></thead>
        <tbody>
          <tr><td>Top by Distributed (USD)</td><td><button class="btn btn-mini" data-view="lb_usd">View</button></td><td><a href="outputs/offchain/catalyst/analytics/leaderboards/top_by_distributed_usd.csv">CSV</a></td></tr>
          <tr><td>Top by Distributed (ADA)</td><td><button class="btn btn-mini" data-view="lb_ada">View</button></td><td><a href="outputs/offchain/catalyst/analytics/leaderboards/top_by_distributed_ada.csv">CSV</a></td></tr>
          <tr><td>Top by Total Projects</td><td><button class="btn btn-mini" data-view="lb_total">View</button></td><td><a href="outputs/offchain/catalyst/analytics/leaderboards/top_by_total_projects.csv">CSV</a></td></tr>
          <tr><td>Top by Funded Projects</td><td><button class="btn btn-mini" data-view="lb_funded">View</button></td><td><a href="outputs/offchain/catalyst/analytics/leaderboards/top_by_funded_projects.csv">CSV</a></td></tr>
          <tr><td>Top by Completed Projects</td><td><button class="btn btn-mini" data-view="lb_completed">View</button></td><td><a href="outputs/offchain/catalyst/analytics/leaderboards/top_by_completed_projects.csv">CSV</a></td></tr>
          <tr><td>Top by Requested (USD)</td><td><button class="btn btn-mini" data-view="lb_requested">View</button></td><td><a href="outputs/offchain/catalyst/analytics/leaderboards/top_by_requested_usd.csv">CSV</a></td></tr>
        </tbody>
      </table>
    </div>

    <details class="viewer" id="viewer">
      <summary>Inline viewer (no download needed)</summary>
      <div class="chart-note" style="margin-top:8px;">Showing a small slice inline for readability. Use CSV download for full receipts.</div>
      <div class="tbl-wrap" style="margin-top:10px;">
        <table id="viewer-table"></table>
      </div>
    </details>

    <p class="chart-note" style="margin-top:12px;">This section is <strong>AI-curated</strong> (choice of views + thresholds), but the derivation is deterministic and fully auditable from the raw dataset. Signals are not accusations.</p>
  </div>
</div>

<div class="divider"></div>

<!-- Projections removed: model outputs not yet published. -->

<div class="divider"></div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     SQL QUERIES
     ═══════════════════════════════════════════════════════════════════════════ -->
<div class="sql-section">
  <div class="s-head">
    <div class="s-label">Reproducibility</div>
    <div class="s-title"><span class="pip" style="background:var(--trs)"></span> db-sync SQL Queries</div>
    <p class="s-desc">Every chart traces to a query. Run against your own cardano-db-sync. These power the bot's automated pipeline.</p>
  </div>

  <div class="sql-block">
    <h3><span class="qn">Q1</span> Treasury + Reserves + Cumulative Fees per Epoch</h3>
    <div class="sd">Foundation query powering both top charts. Computes running total of fees across chain lifetime.</div>
    <pre><span class="k">SELECT</span>
  <span class="v">epoch_no</span>,
  <span class="v">treasury</span>  / <span class="n">1e6</span>  <span class="k">AS</span> <span class="v">treasury_ada</span>,
  <span class="v">reserves</span>  / <span class="n">1e6</span>  <span class="k">AS</span> <span class="v">reserves_ada</span>,
  (<span class="v">treasury</span> + <span class="v">reserves</span>) / <span class="n">1e6</span>  <span class="k">AS</span> <span class="v">combined_ada</span>,
  <span class="v">fees</span> / <span class="n">1e6</span>  <span class="k">AS</span> <span class="v">epoch_fees_ada</span>,
  <span class="f">SUM</span>(<span class="v">fees</span>) <span class="k">OVER</span> (
    <span class="k">ORDER BY</span> <span class="v">epoch_no</span>
  ) / <span class="n">1e6</span>  <span class="k">AS</span> <span class="v">cumulative_fees_ada</span>
<span class="k">FROM</span> <span class="v">ada_pots</span>
<span class="k">ORDER BY</span> <span class="v">epoch_no</span>;</pre>
  </div>

  <div class="sql-block">
    <h3><span class="qn">Q2</span> Treasury Withdrawals — Conway-era Governance Actions</h3>
    <div class="sd">All enacted treasury withdrawals with epoch, amount, destination, tx hash.</div>
    <pre><span class="k">SELECT</span>
  <span class="v">b</span>.<span class="v">epoch_no</span>  <span class="k">AS</span> <span class="v">enacted_epoch</span>,
  <span class="v">tw</span>.<span class="v">amount</span> / <span class="n">1e6</span>  <span class="k">AS</span> <span class="v">amount_ada</span>,
  <span class="f">ENCODE</span>(<span class="v">sa</span>.<span class="v">hash_raw</span>, <span class="s">'hex'</span>)  <span class="k">AS</span> <span class="v">stake_addr</span>,
  <span class="f">ENCODE</span>(<span class="v">tx</span>.<span class="v">hash</span>, <span class="s">'hex'</span>)      <span class="k">AS</span> <span class="v">tx_hash</span>,
  <span class="v">ga</span>.<span class="v">id</span>  <span class="k">AS</span> <span class="v">gov_action_id</span>
<span class="k">FROM</span> <span class="v">treasury_withdrawal</span> <span class="v">tw</span>
<span class="k">JOIN</span> <span class="v">gov_action_proposal</span> <span class="v">ga</span> <span class="k">ON</span> <span class="v">ga</span>.<span class="v">id</span> = <span class="v">tw</span>.<span class="v">gov_action_proposal_id</span>
<span class="k">JOIN</span> <span class="v">stake_address</span> <span class="v">sa</span> <span class="k">ON</span> <span class="v">sa</span>.<span class="v">id</span> = <span class="v">tw</span>.<span class="v">stake_address_id</span>
<span class="k">JOIN</span> <span class="v">tx</span> <span class="k">ON</span> <span class="v">tx</span>.<span class="v">id</span> = <span class="v">ga</span>.<span class="v">tx_id</span>
<span class="k">JOIN</span> <span class="v">block</span> <span class="v">b</span> <span class="k">ON</span> <span class="v">b</span>.<span class="v">id</span> = <span class="v">tx</span>.<span class="v">block_id</span>
<span class="k">WHERE</span> <span class="v">ga</span>.<span class="v">type</span> = <span class="s">'TreasuryWithdrawals'</span>
<span class="k">ORDER BY</span> <span class="v">b</span>.<span class="v">epoch_no</span> <span class="k">DESC</span>, <span class="v">tw</span>.<span class="v">amount</span> <span class="k">DESC</span>;</pre>
  </div>

  <div class="sql-block">
    <h3><span class="qn">Q3</span> NCL Utilization — Cumulative Withdrawals vs. Ceiling</h3>
    <div class="sd">Running total within 2025 NCL window (epochs 532–612).</div>
    <pre><span class="k">WITH</span> <span class="v">wd</span> <span class="k">AS</span> (
  <span class="k">SELECT</span> <span class="v">b</span>.<span class="v">epoch_no</span>, <span class="f">SUM</span>(<span class="v">tw</span>.<span class="v">amount</span>)/<span class="n">1e6</span> <span class="k">AS</span> <span class="v">ep_ada</span>
  <span class="k">FROM</span> <span class="v">treasury_withdrawal</span> <span class="v">tw</span>
  <span class="k">JOIN</span> <span class="v">gov_action_proposal</span> <span class="v">ga</span> <span class="k">ON</span> <span class="v">ga</span>.<span class="v">id</span>=<span class="v">tw</span>.<span class="v">gov_action_proposal_id</span>
  <span class="k">JOIN</span> <span class="v">tx</span> <span class="k">ON</span> <span class="v">tx</span>.<span class="v">id</span>=<span class="v">ga</span>.<span class="v">tx_id</span>
  <span class="k">JOIN</span> <span class="v">block</span> <span class="v">b</span> <span class="k">ON</span> <span class="v">b</span>.<span class="v">id</span>=<span class="v">tx</span>.<span class="v">block_id</span>
  <span class="k">WHERE</span> <span class="v">ga</span>.<span class="v">type</span>=<span class="s">'TreasuryWithdrawals'</span>
    <span class="k">AND</span> <span class="v">b</span>.<span class="v">epoch_no</span> <span class="k">BETWEEN</span> <span class="n">532</span> <span class="k">AND</span> <span class="n">612</span>
  <span class="k">GROUP BY</span> <span class="v">b</span>.<span class="v">epoch_no</span>
)
<span class="k">SELECT</span> <span class="v">epoch_no</span>, <span class="v">ep_ada</span>,
  <span class="f">SUM</span>(<span class="v">ep_ada</span>) <span class="k">OVER</span>(<span class="k">ORDER BY</span> <span class="v">epoch_no</span>) <span class="k">AS</span> <span class="v">cumulative</span>,
  <span class="n">350e6</span> - <span class="f">SUM</span>(<span class="v">ep_ada</span>) <span class="k">OVER</span>(<span class="k">ORDER BY</span> <span class="v">epoch_no</span>) <span class="k">AS</span> <span class="v">headroom</span>
<span class="k">FROM</span> <span class="v">wd</span> <span class="k">ORDER BY</span> <span class="v">epoch_no</span>;</pre>
  </div>

  <div class="sql-block">
    <h3><span class="qn">Q4</span> Governance Action Summary — Budget Categories</h3>
    <div class="sd">All treasury proposals with amounts for budget categorization.</div>
    <pre><span class="k">SELECT</span>
  <span class="v">ga</span>.<span class="v">id</span>, <span class="v">ga</span>.<span class="v">type</span>, <span class="v">ga</span>.<span class="v">description</span>,
  <span class="v">b</span>.<span class="v">epoch_no</span> <span class="k">AS</span> <span class="v">submitted_epoch</span>,
  <span class="v">ga</span>.<span class="v">enacted_epoch</span>, <span class="v">ga</span>.<span class="v">ratified_epoch</span>,
  <span class="f">SUM</span>(<span class="v">tw</span>.<span class="v">amount</span>) / <span class="n">1e6</span> <span class="k">AS</span> <span class="v">total_ada</span>,
  <span class="f">COUNT</span>(<span class="v">tw</span>.<span class="v">id</span>) <span class="k">AS</span> <span class="v">wd_count</span>
<span class="k">FROM</span> <span class="v">gov_action_proposal</span> <span class="v">ga</span>
<span class="k">LEFT JOIN</span> <span class="v">treasury_withdrawal</span> <span class="v">tw</span> <span class="k">ON</span> <span class="v">tw</span>.<span class="v">gov_action_proposal_id</span>=<span class="v">ga</span>.<span class="v">id</span>
<span class="k">JOIN</span> <span class="v">tx</span> <span class="k">ON</span> <span class="v">tx</span>.<span class="v">id</span>=<span class="v">ga</span>.<span class="v">tx_id</span>
<span class="k">JOIN</span> <span class="v">block</span> <span class="v">b</span> <span class="k">ON</span> <span class="v">b</span>.<span class="v">id</span>=<span class="v">tx</span>.<span class="v">block_id</span>
<span class="k">WHERE</span> <span class="v">ga</span>.<span class="v">type</span>=<span class="s">'TreasuryWithdrawals'</span>
<span class="k">GROUP BY</span> <span class="v">ga</span>.<span class="v">id</span>,<span class="v">ga</span>.<span class="v">type</span>,<span class="v">ga</span>.<span class="v">description</span>,
  <span class="v">b</span>.<span class="v">epoch_no</span>,<span class="v">ga</span>.<span class="v">enacted_epoch</span>,<span class="v">ga</span>.<span class="v">ratified_epoch</span>
<span class="k">ORDER BY</span> <span class="v">total_ada</span> <span class="k">DESC NULLS LAST</span>;</pre>
  </div>

  <div class="sql-block">
    <h3><span class="qn">Q5</span> Projection Snapshot — Current State for Modeling</h3>
    <div class="sd">Latest reserves, treasury, trailing avg fees for the projection engine.</div>
    <pre><span class="k">WITH</span> <span class="v">latest</span> <span class="k">AS</span> (
  <span class="k">SELECT</span> * <span class="k">FROM</span> <span class="v">ada_pots</span> <span class="k">ORDER BY</span> <span class="v">epoch_no</span> <span class="k">DESC LIMIT</span> <span class="n">1</span>
),
<span class="v">rf</span> <span class="k">AS</span> (
  <span class="k">SELECT</span> <span class="f">AVG</span>(<span class="v">fees</span>)/<span class="n">1e6</span> <span class="k">AS</span> <span class="v">avg_fee</span>
  <span class="k">FROM</span> <span class="v">ada_pots</span>
  <span class="k">WHERE</span> <span class="v">epoch_no</span> >= (<span class="k">SELECT</span> <span class="f">MAX</span>(<span class="v">epoch_no</span>)-<span class="n">72</span> <span class="k">FROM</span> <span class="v">ada_pots</span>)
),
<span class="v">lifetime</span> <span class="k">AS</span> (
  <span class="k">SELECT</span> <span class="f">SUM</span>(<span class="v">fees</span>)/<span class="n">1e6</span> <span class="k">AS</span> <span class="v">total_fees</span> <span class="k">FROM</span> <span class="v">ada_pots</span>
)
<span class="k">SELECT</span>
  <span class="v">l</span>.<span class="v">epoch_no</span>,
  <span class="v">l</span>.<span class="v">treasury</span>/<span class="n">1e6</span> <span class="k">AS</span> <span class="v">treasury_ada</span>,
  <span class="v">l</span>.<span class="v">reserves</span>/<span class="n">1e6</span> <span class="k">AS</span> <span class="v">reserves_ada</span>,
  <span class="v">lf</span>.<span class="v">total_fees</span> <span class="k">AS</span> <span class="v">lifetime_fee_income_ada</span>,
  <span class="v">rf</span>.<span class="v">avg_fee</span>*<span class="n">73</span> <span class="k">AS</span> <span class="v">est_annual_fees</span>,
  (<span class="v">l</span>.<span class="v">reserves</span>*<span class="n">0.003</span>*<span class="n">0.2</span>*<span class="n">73</span>)/<span class="n">1e6</span> <span class="k">AS</span> <span class="v">est_annual_expansion</span>
<span class="k">FROM</span> <span class="v">latest</span> <span class="v">l</span>, <span class="v">rf</span>, <span class="v">lifetime</span> <span class="v">lf</span>;</pre>
  </div>
</div>

<!-- ═══════════ FOOTER ═══════════ -->
<footer>
  <p class="f1">BEACN Treasury · db-sync · open-source · auditable</p>
  <p class="f2">Keep it simple. Publish receipts. Don't imply guilt from flags.</p>
</footer>

</div><!-- /wrap -->

<!-- ═══════════════════════════════════════════════════════════════════════════
     CHARTS
     ═══════════════════════════════════════════════════════════════════════════ -->
<script type="module">
Chart.defaults.color='#4f6479';
Chart.defaults.borderColor='#1a2332';
Chart.defaults.font.family='Instrument Sans,system-ui';
Chart.defaults.font.size=11;
const cG={color:'rgba(26,35,50,.6)'}, nG={display:false};

// ── Data (wired to published outputs where available) ──
// Fees: lifetime cumulative from epoch table (genesis→tip)
// Pots: reserves/treasury from epoch export (Shelley-era coverage)
async function fetchText(url){
  const r=await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error(`fetch ${url} -> ${r.status}`);
  return await r.text();
}
function parseCSV(t){
  const lines=t.trim().split(/\r?\n/);
  const h=lines[0].split(',');
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const c=lines[i].split(',');
    const o={};
    h.forEach((k,idx)=>o[k]=c[idx]);
    rows.push(o);
  }
  return rows;
}
function toNum(x){
  const v=Number(x);
  return Number.isFinite(v)?v:null;
}

let eps=[], R=[], T=[], CF=[];

// Load fee income (epoch 0..tip)
const feeRows=parseCSV(await fetchText('outputs/onchain/fee_income_epoch.csv'));
const feeE=feeRows.map(r=>toNum(r.epoch_no));
const feeCum=feeRows.map(r=>toNum(r.cumulative_fees_ada));

// For chart scaling, use ₳M
const feeLabels=feeE.map(e=>'E'+e);
const feeCumM=feeCum.map(v=>v===null?null:(v/1e6));

// Load pots (reserves/treasury)
const potRows=parseCSV(await fetchText('outputs/epoch_treasury_fees.csv'));
const potE=potRows.map(r=>toNum(r.epoch_no));
const res=potRows.map(r=>toNum(r.reserves_start_ada));
const trs=potRows.map(r=>toNum(r.treasury_end_ada));

// Convert to ₳M for chart 2
const potLabels=potE.map(e=>'E'+e);
const resM=res.map(v=>v===null?null:(v/1e6));
const trsM=trs.map(v=>v===null?null:(v/1e6));

// ════════════════════════════════════════════════════════════════
// CHART 1: Cumulative TX Fee Income (revenue)
// ════════════════════════════════════════════════════════════════
new Chart(document.getElementById('feeIncomeChart'),{
  type:'line',
  data:{
    labels:feeLabels,
    datasets:[
      {label:'Cumulative Fee Income (₳M)',data:feeCumM,borderColor:'#34d399',backgroundColor:'rgba(52,211,153,.06)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5,yAxisID:'y'}
    ]
  },
  options:{
    responsive:true,
    interaction:{mode:'index',intersect:false},
    plugins:{legend:{display:false}},
    scales:{
      y:{position:'left',title:{display:true,text:'₳M (Cumulative Fees)',color:'#34d399'},grid:cG},
      x:{grid:nG,ticks:{maxTicksLimit:14}}
    }
  }
});

// ════════════════════════════════════════════════════════════════
// CHART 2: Treasury + Reserves (spending pools only)
// ════════════════════════════════════════════════════════════════
new Chart(document.getElementById('treasuryReservesChart'),{
  type:'line',
  data:{
    labels:potLabels,
    datasets:[
      {label:'Reserves (₳M)',data:resM,borderColor:'#a78bfa',backgroundColor:'rgba(167,139,250,.04)',fill:true,tension:.3,pointRadius:0,borderWidth:2,yAxisID:'y'},
      {label:'Treasury (₳M)',data:trsM,borderColor:'#22d3ee',backgroundColor:'rgba(34,211,238,.04)',fill:true,tension:.3,pointRadius:0,borderWidth:2,yAxisID:'y'}
    ]
  },
  options:{
    responsive:true,
    interaction:{mode:'index',intersect:false},
    plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:16}}},
    scales:{
      y:{position:'left',title:{display:true,text:'₳M (Treasury & Reserves)',color:'#4f6479'},grid:cG},
      x:{grid:nG,ticks:{maxTicksLimit:14}}
    }
  }
});

// ════════════════════════════════════════════════════════════════
// CATALYST BAR (off-chain, wired to published outputs)
// ════════════════════════════════════════════════════════════════
try {
  const fundRows = parseCSV(await fetchText('outputs/offchain/catalyst/funds.csv'));
  const labels = fundRows.map(r => 'F' + r.fund_id);
  const usd = fundRows.map(r => {
    const v = toNum(r.distributed_usd);
    return v===null?0:(v/1e6); // show as $M
  });

  new Chart(document.getElementById('catalystBarChart'),{
    type:'bar',
    data:{
      labels:labels,
      datasets:[{label:'Distributed (USD, $M)',data:usd,backgroundColor:'rgba(129,140,248,.6)',borderRadius:4}]
    },
    options:{responsive:true,plugins:{legend:{display:false}},
      scales:{x:{grid:nG},y:{grid:cG,title:{display:true,text:'$M',color:'#4f6479'}}}}
  });
} catch (e) {
  // If off-chain outputs not present, leave chart empty.
}

// ── Catalyst analytics (AI-curated, deterministic) ──
try {
  const conc = JSON.parse(await fetchText('outputs/offchain/catalyst/analytics/concentration.json'));
  const top10 = (conc.shares && conc.shares.top10) ? (conc.shares.top10*100).toFixed(1)+'%' : '—';
  const top50 = (conc.shares && conc.shares.top50) ? (conc.shares.top50*100).toFixed(1)+'%' : '—';
  const el10 = document.getElementById('catalyst-conc-top10');
  const el50 = document.getElementById('catalyst-conc-top50');
  if (el10) el10.textContent = top10;
  if (el50) el50.textContent = top50;
} catch (e) { /* ignore */ }

try {
  const meta = JSON.parse(await fetchText('outputs/offchain/catalyst/analytics/meta.json'));
  const n = meta.counts && meta.counts.signals_rows ? meta.counts.signals_rows : null;
  const el = document.getElementById('catalyst-signals-count');
  if (el) el.textContent = (n===null? '—' : String(n));
} catch (e) { /* ignore */ }

// Inline viewer wiring
const INDEX_PATH = 'outputs/offchain/catalyst/analytics/proposers_index.csv';

const VIEW_SORT = {
  lb_usd: { key: 'total_distributed_usd', desc: true },
  lb_ada: { key: 'distributed_ada_from_json', desc: true },
  lb_total: { key: 'total_projects', desc: true },
  lb_funded: { key: 'funded_projects', desc: true },
  lb_completed: { key: 'completed_projects', desc: true },
  lb_requested: { key: 'total_requested_usd', desc: true },
};

function renderTable(el, rows, maxRows=30){
  if(!el) return;
  if(!rows || rows.length===0){ el.innerHTML=''; return; }
  const headers = Object.keys(rows[0]);
  const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const bodyRows = rows.slice(0,maxRows).map(r=>{
    return `<tr>${headers.map(h=>`<td>${(r[h]??'')}</td>`).join('')}</tr>`;
  }).join('');
  el.innerHTML = thead + `<tbody>${bodyRows}</tbody>`;
}

function parseCSVRows(t){
  const lines=t.trim().split(/\r?\n/);
  const h=lines[0].split(',');
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const c=lines[i].split(',');
    const o={};
    h.forEach((k,idx)=>o[k]=c[idx]);
    rows.push(o);
  }
  return rows;
}

let __INDEX_CACHE = null;

function toNumOrStr(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : (v ?? '');
}

async function loadIndex(){
  if(__INDEX_CACHE) return __INDEX_CACHE;
  const text = await fetchText(INDEX_PATH);
  __INDEX_CACHE = parseCSVRows(text).map(r => {
    // pre-coerce common numeric fields for sorting
    const o = { ...r };
    ['total_projects','funded_projects','completed_projects','total_distributed_usd','total_requested_usd','total_remaining_usd','distributed_ada_from_json']
      .forEach(k => { if (k in o) o[k] = Number(o[k] || 0); });
    return o;
  });
  return __INDEX_CACHE;
}

async function openViewer(viewKey){
  const cfg = VIEW_SORT[viewKey];
  if(!cfg) return;

  const viewer = document.getElementById('viewer');
  const table = document.getElementById('viewer-table');
  if(viewer) viewer.open = true;

  const rows = await loadIndex();
  const sorted = [...rows].sort((a,b) => {
    const av = a[cfg.key] ?? 0;
    const bv = b[cfg.key] ?? 0;
    return cfg.desc ? (bv - av) : (av - bv);
  });

  renderTable(table, sorted, 30);
  if(viewer) viewer.scrollIntoView({behavior:'smooth', block:'start'});
}

document.querySelectorAll('button[data-view]').forEach(btn=>{
  btn.addEventListener('click', ()=> openViewer(btn.getAttribute('data-view')));
});

</script>

</body>
</html>
